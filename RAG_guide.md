# RAGシステム設計・運用ガイド

## 概要

本ドキュメントは、チームで共有するRAG（Retrieval-Augmented Generation）システムの運用指針・設計思想・ベストプラクティスをまとめたものです。
個人メモをもとに、プロダクション運用・共同開発に適した内容へ再編成しています。

---

## 1. システム全体の流れ

1. **ユーザープロンプト受付**  
   ユーザーが自然言語で質問・依頼を入力

2. **LLMによる意図解釈＆情報拡張**  
   - 曖昧なプロンプトは追加質問で具体化
   - 明確なものは検索向きのプロンプトへ再整形

3. **プロンプトのベクトル化**  
   - 拡張/再整形済みプロンプトを埋め込みモデルでベクトル化

4. **ベクトルDB検索**  
   - 類似度で上位の文書チャンクを取得
   - メタ情報（mdファイル名など）で出所を特定・全体像も補足

5. **LLMによる最終整理＆回答生成**  
   - 取得文書を要約・編集し、分かりやすい形でユーザーに返答

---

## 2. データパイプライン設計

### 2.1 Markdown一元管理

- すべてのデータソース（PDF, Word, Excel, CSV等）は一旦.md形式へ変換
- 変換には[MarkItDown](https://qiita.com/Leapcell/items/c8787a267dd3a262fce8)等を利用（ただしOCR非対応PDF等の限界あり）
- mdファイル名・格納ディレクトリ構造を揃えることで変換・メンテナンスを自動化

### 2.2 LLMによるノイズ除去・整合性チェック

- 変換後データはLLMで検品・再整形（ノイズ除去・構造修正）
- RAG品質はデータ品質に依存→自動化と手動確認の併用が推奨

### 2.3 チャンク分割・ベクトル化

- LangChain等でセマンティックチャンク分割
- 埋め込みモデル（例:intfloat/multilingual-e5-large）でベクトル化

### 2.4 メタデータ付与

- 各チャンクに元ファイル名・作成日時・著者などのメタデータ付与
- 後続の検索・出所追跡・データ鮮度確認に必須

---

## 3. ベクトルDB設計と正規化二層運用

### 3.1 埋め込み専用DB（未正規化）

- 新規情報はまずこちらへ逐次追加
- 入力バッチサイズや更新頻度は要件に応じて調整

### 3.2 参照用DB（正規化済み）

- 定期バッチ処理で正規化（L2ノルムなど）し、参照DBへ同期
- 類似度検索・分析は常に正規化済みDBで実施
- データの一貫性・再現性・パフォーマンスの両立

### 3.3 DBのメタ管理

- 出所追跡のためリレーショナルDBと連携し、  
  `ベクトル本体`＋`テキスト`＋`mdファイル名`＋`日付/著者` などを管理
- 例: PostgreSQL＋pgvector拡張, GINインデックスで高速全文検索

---

## 4. バッチ正規化処理のフロー

1. ベクトルリストの長さからバッチサイズを決定
2. 各バッチ内で最大値・最小値を算出し正規化パラメータ取得
3. 正規化済みバッチを再結合して新リスト生成
4. スケーラビリティ・効率の観点でバッチ化は推奨

---

## 5. ベストプラクティス・注意事項

- MarkItDown等の自動変換ツールには制約がある（OCR未対応・レイアウト崩れ等）
- md化後もLLMによる追加検品・再整形推奨
- RAG品質＝データ品質。ノイズ・誤情報混入を未然に防ぐ
- メタデータ（mdファイル名等）管理で透明性・トレーサビリティ強化
- DBの権限管理・アクセス制御も忘れずに

---

## 6. 参考ツール・実装例

- [MarkItDown](https://qiita.com/Leapcell/items/c8787a267dd3a262fce8): 複数形式→Markdown変換
- LangChain: セマンティックチャンク分割とパイプライン設計
- PostgreSQL/pgvector: ベクトルDB＋メタデータ管理

---

## 7. 今後の拡張案

- WebUI/ダッシュボード・API連携で利用性向上
- データ自動更新・品質検証パイプラインの標準化
- 知人限定公開/認証制限などMCP連携も柔軟に追加可能

---

## 8. ディレクトリ構造

```
NakedRAG/
├── data/                # データ格納ディレクトリ
│   ├── markdowns/      # 変換後のMarkdownファイル
│   └── source/         # 元データファイル
│       ├── csv/        # CSVファイル
│       ├── excel/      # Excelファイル
│       ├── html/       # HTMLファイル
│       ├── json/       # JSONファイル
│       ├── markdown/   # 元のMarkdownファイル
│       ├── pdf/        # PDFファイル
│       ├── powerpoint/ # PowerPointファイル
│       ├── voice/      # 音声ファイル
│       └── word_txt/   # Word・テキストファイル
├── db/                 # ベクトルDB関連ファイル
├── docs/               # ドキュメント
├── models/             # モデルファイル
└── src/                # ソースコード
    ├── __init__.py
    ├── cli.py         # CLIインターフェース
    ├── document_processor.py    # ドキュメント処理
    ├── embedding_generator.py   # 埋め込み生成
    ├── example_tool.py         # ツール例
    ├── main.py                 # メインスクリプト
    ├── mcp_server.py          # MCPサーバー
    ├── rag_service.py         # RAGサービス
    ├── rag_tools.py           # RAGツール
    └── vector_database.py     # ベクトルDB操作
```

各ディレクトリの役割：

- `data/`: すべてのデータファイルを管理
  - `markdowns/`: 各種ファイルをMarkdown形式に変換した後の保存先
  - `source/`: 元データファイルを形式別に整理して保存
- `db/`: ベクトルDBのデータファイルやインデックスを保存
- `docs/`: プロジェクト関連のドキュメント
- `models/`: 使用する機械学習モデルの保存先
- `src/`: Pythonソースコード
  - 各モジュールが単一責任の原則に従い、明確な役割を持つ

---
